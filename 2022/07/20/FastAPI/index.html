<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/favicon.png"/>
	<link rel="shortcut icon" href="/img/favicon.png">
	<meta name="baidu-site-verification" content="code-KLcpk3wnwR" />
	
			<title>趙天一ლ(ﾟдﾟლ)You know、You don’t know</title>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, user-scalable=no"
/>
<link rel="stylesheet" href="/css/mic_main.css" />
<link rel="stylesheet" href="/css/dropdownMenu.css" />
<!-- <script src="/js/live2d/autoload.js"></script> -->

<meta name="keywords" content="Zssaer JavaWeb TIANYI ZHAO" />

<noscript>
  <link rel="stylesheet" href="/css/noscript.css" />
</noscript>
<style type="text/css">
  /* body{
    background: url('https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-r7r551.jpg?x-oss-process=style/wallpaper') center 0 no-repeat;
    content: " ";
    position: fixed;
  } */
  body:before {
    content: " ";
    position: fixed;
    top: 0;
    background: url('https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-r7r551.jpg?x-oss-process=style/wallpaper') center 0 no-repeat;

    right: 0;
    bottom: 0;
    left: 0;
    background-size: cover;
  }
</style>

			    

    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.scrollex.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.scrolly.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/skel.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/util.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/main.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>
    
		<!-- Layouts -->


<!--  代码渲染  -->
<script src="/js/prism.js"></script>
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body
  class=""
  data-prismjs-copy="复制"
  data-prismjs-copy-error="请按Ctrl+C手动复制"
  data-prismjs-copy-success="复制成功!"
>
  <div class="mask-border"></div>
  <!-- Wrapper 外包 s-->
  <div id="wrapper" class="fade-in">
    <!-- Intro 头部显示 s -->
    <!-- Intro 头部显示 e -->
    <!-- Header 头部logo start -->
    <header id="header">
    <a href="/" class="logo">Refrain</a>
</header>
    <!-- Nav 导航条 start -->
    <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">Home</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">Categories</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/JAVA/">JAVA</a></li><li><a class="category-link" href="/categories/Python/">Python</a></li><li><a class="category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li><a class="category-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a></li><li><a class="category-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="AboutMe">
		                AboutMe
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="Wallpaper">
		                Wallpaper
		            </a>
		        </li>
		        
		        <li>
		            <a href="/bangumis/" title="Bangumis">
		                Bangumis
		            </a>
		        </li>
		        
						<li class="active">
							<a href="#s1">Other</a>
											<ul class="submenu">
													<li>
													<a class="category-link" href="/another/billiard.html">台球模拟V1.0</a>
												</li>
											</ul>
						</li>

            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/Zssaer" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="git" href="https://gitee.com/Zssaer01" target="_blank" rel="noopener">
                            <i class="icon fa fa-git"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>
    <aside id="toc_menu"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastAPI"><span class="toc-number">1.</span> <span class="toc-text">FastAPI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API%E6%96%87%E6%A1%A3%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.3.</span> <span class="toc-text">API文档页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.4.</span> <span class="toc-text">详细学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%B9%A6%E5%86%99"><span class="toc-number">1.4.2.</span> <span class="toc-text">接口的书写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E6%96%B9%E6%B3%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">GET方法请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POST%E6%96%B9%E6%B3%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">POST方法请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">请求模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E6%95%88%E9%AA%8C"><span class="toc-number">1.4.2.3.1.</span> <span class="toc-text">声明效验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.2.3.2.</span> <span class="toc-text">高级类型定义</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">声明示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E6%9F%A5%E8%AF%A2%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93%E5%8F%82%E6%95%B0%E6%8B%BC%E8%A3%85"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">GET查询的请求体参数拼装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUT%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">PUT更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%B4%E9%83%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">请求头部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.5.</span> <span class="toc-text">响应模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.6.</span> <span class="toc-text">表单数据请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.7.</span> <span class="toc-text">上传文件请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">多文件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.</span> <span class="toc-text">抛出错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E6%99%AE%E9%80%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.1.</span> <span class="toc-text">抛出普通浏览器错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.2.</span> <span class="toc-text">抛出自定义错误</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.9.</span> <span class="toc-text">路径操作配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.9.1.</span> <span class="toc-text">返回状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.9.2.</span> <span class="toc-text">接口分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.9.3.</span> <span class="toc-text">接口说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Json%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.10.</span> <span class="toc-text">Json转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%93%8D%E5%BA%94"><span class="toc-number">1.4.11.</span> <span class="toc-text">自定义响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.12.</span> <span class="toc-text">安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2"><span class="toc-number">1.4.12.1.</span> <span class="toc-text">OAuth2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0OAuth2"><span class="toc-number">1.4.12.2.</span> <span class="toc-text">实现OAuth2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.12.3.</span> <span class="toc-text">设置认证方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AE%A4%E8%AF%81%E5%88%A4%E6%96%AD"><span class="toc-number">1.4.12.4.</span> <span class="toc-text">设置认证判断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0JWT%E4%BB%A5%E5%8F%8AHash%E5%8A%A0%E5%AF%86%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.12.5.</span> <span class="toc-text">实现JWT以及Hash加密认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Hash%E5%8A%A0%E5%AF%86"><span class="toc-number">1.4.12.5.1.</span> <span class="toc-text">Hash加密</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-JWT"><span class="toc-number">1.4.12.5.2.</span> <span class="toc-text">关于 JWT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JWT%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.12.5.3.</span> <span class="toc-text">JWT实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.4.13.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.4.13.1.</span> <span class="toc-text">创建中间件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AECORS"><span class="toc-number">1.4.14.</span> <span class="toc-text">配置CORS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%92%8C%E6%96%87%E6%A1%A3-URL"><span class="toc-number">1.4.15.</span> <span class="toc-text">元数据和文档 URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%82%E8%BD%BD%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">1.4.16.</span> <span class="toc-text">挂载静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.17.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">1.4.17.1.</span> <span class="toc-text">编写测试用例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.17.2.</span> <span class="toc-text">运行测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.4.18.</span> <span class="toc-text">环境变量</span></a></li></ol></li></ol></li></ol></aside>
    <div id="main">
      
      <div
        class="post_page_title_img"
        style="
          height: 25rem;
          background-image: url(https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-rd819j_1280x720.png?x-oss-process=style/wallpaper);
          background-position: center;
          background-repeat: no-repeat;
          background-size: cover;
          -moz-background-size: cover;
          overflow: hidden;
        "
      >
        <a href="#" style="padding: 4rem 4rem 2rem 4rem"
          ><h2 id="page-title">FastAPI教程</h2></a
        >
      </div>
      
      <button id="toc_button" onclick="openTocSidebar()">文章导航</button>
      <!-- <div id="content_toc">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastAPI"><span class="toc-number">1.</span> <span class="toc-text">FastAPI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API%E6%96%87%E6%A1%A3%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.3.</span> <span class="toc-text">API文档页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.4.</span> <span class="toc-text">详细学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%B9%A6%E5%86%99"><span class="toc-number">1.4.2.</span> <span class="toc-text">接口的书写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E6%96%B9%E6%B3%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">GET方法请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POST%E6%96%B9%E6%B3%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">POST方法请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">请求模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E6%95%88%E9%AA%8C"><span class="toc-number">1.4.2.3.1.</span> <span class="toc-text">声明效验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.2.3.2.</span> <span class="toc-text">高级类型定义</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">声明示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E6%9F%A5%E8%AF%A2%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93%E5%8F%82%E6%95%B0%E6%8B%BC%E8%A3%85"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">GET查询的请求体参数拼装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUT%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">PUT更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%B4%E9%83%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">请求头部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.5.</span> <span class="toc-text">响应模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.6.</span> <span class="toc-text">表单数据请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.7.</span> <span class="toc-text">上传文件请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">多文件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.</span> <span class="toc-text">抛出错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E6%99%AE%E9%80%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.1.</span> <span class="toc-text">抛出普通浏览器错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%9B%E5%87%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.8.2.</span> <span class="toc-text">抛出自定义错误</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.9.</span> <span class="toc-text">路径操作配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.9.1.</span> <span class="toc-text">返回状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.9.2.</span> <span class="toc-text">接口分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"><span class="toc-number">1.4.9.3.</span> <span class="toc-text">接口说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Json%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.10.</span> <span class="toc-text">Json转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%93%8D%E5%BA%94"><span class="toc-number">1.4.11.</span> <span class="toc-text">自定义响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.12.</span> <span class="toc-text">安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2"><span class="toc-number">1.4.12.1.</span> <span class="toc-text">OAuth2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0OAuth2"><span class="toc-number">1.4.12.2.</span> <span class="toc-text">实现OAuth2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AE%A4%E8%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.12.3.</span> <span class="toc-text">设置认证方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AE%A4%E8%AF%81%E5%88%A4%E6%96%AD"><span class="toc-number">1.4.12.4.</span> <span class="toc-text">设置认证判断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0JWT%E4%BB%A5%E5%8F%8AHash%E5%8A%A0%E5%AF%86%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.12.5.</span> <span class="toc-text">实现JWT以及Hash加密认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Hash%E5%8A%A0%E5%AF%86"><span class="toc-number">1.4.12.5.1.</span> <span class="toc-text">Hash加密</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-JWT"><span class="toc-number">1.4.12.5.2.</span> <span class="toc-text">关于 JWT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JWT%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.12.5.3.</span> <span class="toc-text">JWT实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.4.13.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.4.13.1.</span> <span class="toc-text">创建中间件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AECORS"><span class="toc-number">1.4.14.</span> <span class="toc-text">配置CORS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%92%8C%E6%96%87%E6%A1%A3-URL"><span class="toc-number">1.4.15.</span> <span class="toc-text">元数据和文档 URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%82%E8%BD%BD%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">1.4.16.</span> <span class="toc-text">挂载静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.17.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">1.4.17.1.</span> <span class="toc-text">编写测试用例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.17.2.</span> <span class="toc-text">运行测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.4.18.</span> <span class="toc-text">环境变量</span></a></li></ol></li></ol></li></ol>
            </div>     -->

      <!-- Post -->
      <div class="typo" style="padding: 3rem"><h1 id="FastAPI"><a href="#FastAPI" class="headerlink" title="FastAPI"></a>FastAPI</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/logo-fastApi.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tiangolo/fastapi">FastAPI</a> 是一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示。</p>
<p>它拥有的关键特性:</p>
<ul>
<li><strong>快速</strong>：可与 <strong>NodeJS</strong> 和 <strong>Go</strong> 比肩的极高性能（归功于 Starlette 和 Pydantic）。<a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/zh/#_11">最快的 Python web 框架之一</a>。</li>
<li><strong>高效编码</strong>：提高功能开发速度约 200％ 至 300％。*</li>
<li><strong>更少 bug</strong>：减少约 40％ 的人为（开发者）导致错误。*</li>
<li><strong>智能</strong>：极佳的编辑器支持。处处皆可自动补全，减少调试时间。</li>
<li><strong>简单</strong>：设计的易于使用和学习，阅读文档的时间更短。</li>
<li><strong>简短</strong>：使代码重复最小化。通过不同的参数声明实现丰富功能。bug 更少。</li>
<li><strong>健壮</strong>：生产可用级别的代码。还有自动生成的交互式文档。</li>
<li><strong>标准化</strong>：基于（并完全兼容）API 的相关开放标准：<a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification">OpenAPI</a> (以前被称为 Swagger) 和 <a target="_blank" rel="noopener" href="https://json-schema.org/">JSON Schema</a>。</li>
</ul>
<p>FastAPI相比于其余的Python Web框架来说，主要用于构建后端API方向，它拥有比其余的Python Web框架更好的性能。启动时间十分之快，极大提升了开发进度。并且自动拥有API文档界面，更方便的支持类型输入。</p>
<p>FastAPI是去年2021年Github上年度最佳新兴框架，目前在GitHub上拥有45.5K的Star，被多个国际大公司所认可，十分具有学习、使用价值。</p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>在学习使用FastAPI前，确保运行环境下安装Python3.6以上版本，因为FastAPI基于Python3.6+设计。</p>
<p>按正常流程是安装 <strong>FastAPI</strong> ，但是这里不建议直接在CMD中使用PIP安装。</p>
<p>这里 以项目形式，使用Pycharm IDE来进行学习。创建一个正常的Python项目，在项目中安装FastAPI、uvicorn，其中uvicorn是一个目前流行的异步服务器。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/20220526165625.png"></p>
<p>随后在项目 <code>main.py</code>文件中输入如下内容：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>点击运行main。成功在127.0.0.1:8000下启动服务器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">INFO:     Started server process <span class="token punctuation">[</span><span class="token number">34400</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面内容就定义了一个首页的API输出，打开浏览器、后者使用第三方工具 访问<a href="http://127.0.0.1:8000页面。">http://127.0.0.1:8000页面。</a></p>
<p>会发现成功输出了<code>&#123;&quot;message&quot;: &quot;Hello World&quot;&#125;</code>内容，这一切都使用了RestAPI形式。</p>
<h2 id="API文档页面"><a href="#API文档页面" class="headerlink" title="API文档页面"></a>API文档页面</h2><p>前面提到了FastAPI中自动生成了API文档页面，这一切都不需要配置。</p>
<p>在服务器启动状态下，访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a> 页面，你将会看到自动生成的交互式 API 文档，它使用Swagger UI形式。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/index-01-swagger-ui-simple.png"></p>
<p>除了Swagger-UI文档之外，FastAPI还内置了ReDoc形式文档，进入<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/redoc">http://127.0.0.1:8000/redoc</a> 即可。</p>
<h2 id="详细学习"><a href="#详细学习" class="headerlink" title="详细学习"></a>详细学习</h2><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><p>从上面的入门中，我们就可以发现，要启动整个FastAPI服务器的话，分3大部分：</p>
<ol>
<li><p>创建FastAPI的实例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>创建对应接口：这一部分就是我们需要关注项目的主要部分之一了。</p>
</li>
<li><p>在Python文件入口中，开启服务器：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="接口的书写"><a href="#接口的书写" class="headerlink" title="接口的书写"></a>接口的书写</h3><h4 id="GET方法请求"><a href="#GET方法请求" class="headerlink" title="GET方法请求"></a>GET方法请求</h4><p>FastAPI的接口写法和Java的Spring的Restful API写法十分相像。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 动态路径的请求</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/param/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_param</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"itemId"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"This is a param content"</span><span class="token punctuation">&#125;</span>

fake_items_db <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Baz"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>

<span class="token comment"># 参数查询的请求</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get1</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> fake_items_db<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 可选参数的设置</span>
<span class="token comment"># 其中Union为typing 包函数</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get2</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>limit<span class="token punctuation">:</span>Union<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> limit<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> fake_items_db<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> fake_items_db<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面为FastAPI中GET方法的一些使用方法。</p>
<p>其中<code>@app.get()</code>注解，表示其为GET方法的接口，它需要接受一个路径，用作API地址。相应的POST、DELETE、PUT都是同样类似方法。</p>
<p>API接口可以使用<code>async</code>异步，表示此接口为异步步骤，与不带异步关键字的 接口的使用区别：</p>
<blockquote>
<p>当你使用到第三方库时，需要调用到它们<code>await</code>时，就需要在接口函数<code>def</code>前使用<code>async</code>，才能实现异步并发效果。</p>
<p>而当您正在使用与某些东西（数据库、API、文件系统等）通信并且不支持使用的第三方库<code>await</code>（目前大多数数据库库都是这种情况），然后声明您的<em>路径操作</em>正常运行，只需<code>def</code>即可。</p>
<p>而当你的项目中，不必与其它东西进行链接通讯时，使用<code>async def</code>可以获得最佳性能。</p>
</blockquote>
<p>FastAPI在输入参数可以对其参数类型进行 规定，并且可以设置默认值。当API 输入的参数类型不一致的话，FastAPI会抛出类型错误。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get1</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>默认情况下入参是必输内容。但利用Python3.5+类型的特性（参数类型支持2个），结合Union函数，在另一个参数类型中定义None，并且设置默认值为None，即可将其参数设置为可选参数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get2</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>limit<span class="token punctuation">:</span>Union<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>除了查询参数的可选设置，还可以设置响应的检验：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Query

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> results<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​    这里的<code>q: Union[str, None] = Query(default=None, max_length=50)</code>，表示这个参数时一个可选参数并且最大长度为50。除了Query中有 max_length外，还拥有最小值检验<code>min_length</code>。</p>
<p>也可以在正则表达式检验：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">q<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token string">"^fixedquery$"</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上述Query中都带有default，表明这个是可选输入参数。对于必须参数的话，不要带有default：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">q<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span>min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>除此之外，Query还支持下面这些内容定义：</p>
<ul>
<li>default：参数的默认值。</li>
<li>title：参数的标题。用作在 OpenAPI 和自动 API 文档用户界面中作为 API 的标题/名称使用。</li>
<li>description：参数的说明。用作在 OpenAPI 和自动 API 文档用户界面中对该参数的描述。</li>
<li>gt：要求参数大于这个值，必须为数字。</li>
</ul>
<h4 id="POST方法请求"><a href="#POST方法请求" class="headerlink" title="POST方法请求"></a>POST方法请求</h4><p>如上所描述，FastAPI的POST方法请求使用的<code>@app.post()</code>注解。同样PUT方法使用<code>@app.put()</code>注解。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="请求模型"><a href="#请求模型" class="headerlink" title="请求模型"></a>请求模型</h4><p>在项目中通常是将请求内容封装为请求模型，当做请求的模型。</p>
<p>要将其请求参数组装为模型的话，这个请求模型要继承<code>pydantic</code> 的 <code>BaseModel</code>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Union

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel

<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item_dict <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item<span class="token punctuation">.</span>tax<span class="token punctuation">:</span>
        price_with_tax <span class="token operator">=</span> item<span class="token punctuation">.</span>price <span class="token operator">+</span> item<span class="token punctuation">.</span>tax
        item_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"price_with_tax"</span><span class="token punctuation">:</span> price_with_tax<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> item_dict<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在请求函数内部，还可以利用<code>dict</code>函数提取到对应dict，然后使用update可以向提交的请求体中添加内容。</p>
<p><strong>注意：你不能使用 <code>GET</code> 操作（HTTP 方法）发送请求体。</strong></p>
<p>要发送数据，你必须使用下列方法之一：<code>POST</code>（较常见）、<code>PUT</code>、<code>DELETE</code> 或 <code>PATCH</code>。</p>
<p>对于同时请求链接中拥有路径参数时，FastAPI 将识别出与路径参数匹配的函数参数应<strong>从路径中获取</strong>，而声明为 Pydantic 模型的函数参数应<strong>从请求体中获取</strong>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token operator">**</span>item<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们除了定义请求模型之外，通常情况下还需要对每个参数在接口文档中进行说明，否则接口文档中的参数很难被其他人所明白。</p>
<h5 id="声明效验"><a href="#声明效验" class="headerlink" title="声明效验"></a>声明效验</h5><p>对请求模型的参数使用 Pydantic 的 <code>Field</code> 即可对参数进行声明校验和元数据等。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">"说明"</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">300</span>
    <span class="token punctuation">)</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>gt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"这个金额必须大于0!"</span><span class="token punctuation">)</span>
    tax<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用Fileld就和前面提到的Query一样。</p>
<h5 id="高级类型定义"><a href="#高级类型定义" class="headerlink" title="高级类型定义"></a>高级类型定义</h5><p>在创建请求体时，除了使用常规的基本类型外，还可以使用List类型、Set类型：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tags1<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tags2<span class="token punctuation">:</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    tags3<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>不只是请求体，对于请求函数的单独入参也可以这样声明。</p>
<p>还可以接受另外一个模型，用来嵌套：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Image</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url<span class="token punctuation">:</span> <span class="token builtin">str</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>


<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    image<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>Image<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="声明示例"><a href="#声明示例" class="headerlink" title="声明示例"></a>声明示例</h4><p>对于接口文档，我们可以对请求体的内容声明一个示例，用作在接口文档上示例。</p>
<p>只需要在请求体模型内定义一个<code>Config</code>类，在其<code>schema_extra</code>中定义“example”：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        schema_extra <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"A very nice Item"</span><span class="token punctuation">,</span>
                <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">35.4</span><span class="token punctuation">,</span>
                <span class="token string">"tax"</span><span class="token punctuation">:</span> <span class="token number">3.2</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="GET查询的请求体参数拼装"><a href="#GET查询的请求体参数拼装" class="headerlink" title="GET查询的请求体参数拼装"></a>GET查询的请求体参数拼装</h4><p>前面提到了创建BaseModel作为请求体可以大幅减少请求重复使用的问题，以及规范化请求。但是也提到了只能使用到POST相关的请求接口上，GET相关请求无法使用。</p>
<p>对于GET请求的请求体创建使用，官方称之为使用依赖注入机制。它有2种实现方式：</p>
<ul>
<li><p>第一种实现方法：依赖项就是一个函数，且可以使用与<em>路径操作函数</em>相同的参数，它返回对应的GET查询请求的内容：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">common_parameters</span><span class="token punctuation">(</span>
    q<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">,</span> <span class="token string">"skip"</span><span class="token punctuation">:</span> skip<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>commons<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>common_parameters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> commons<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里创建了一个<code>common_parameters</code>函数当做依赖项。在请求接口的输入参数中输入dict，使用Depends函数。</p>
<p>这样这个请求接口输入参数就会有 依赖项返回的内容了。</p>
</li>
<li><p>第二种实现方法：创建一个请求类，继承BaseModel，内部参数遵循查询参数写法：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    age<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_root</span><span class="token punctuation">(</span>student<span class="token punctuation">:</span> Student <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>name<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">:</span> student<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>age<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">:</span> student<span class="token punctuation">.</span>age<span class="token punctuation">&#125;</span>是<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接在GET请求入参下输入对应请求类，默认值上使用<code>Depends()</code>。这样既可将其请求类以查询参数方式进行工作。</p>
</li>
</ul>
<h4 id="PUT更新"><a href="#PUT更新" class="headerlink" title="PUT更新"></a>PUT更新</h4><p>  更新数据请用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/PUT">HTTP <code>PUT</code></a> 操作。</p>
<p>把输入数据转换为以 JSON 格式存储的数据（比如，使用 NoSQL 数据库时），可以使用 <code>jsonable_encoder</code>。例如，把 <code>datetime</code> 转换为 <code>str</code>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    update_item_encoded <span class="token operator">=</span> jsonable_encoder<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span> <span class="token operator">=</span> update_item_encoded
    <span class="token keyword">return</span> update_item_encoded<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>FastAPI利用Pydantic来实现类型检验。它支持多种数据类型，其中数据有一些常用的数据类型：</p>
<ul>
<li>int</li>
<li>float</li>
<li>str</li>
<li>bool</li>
</ul>
<p>除此之外，还有众多其他数据类型：</p>
<ul>
<li>UUID：一种标准的 “通用唯一标识符” ，在许多数据库和系统中用作ID。在请求和响应中将以 <code>str</code> 表示。</li>
<li>datetime.datetime：在请求和响应中将表示为 ISO 8601 时间格式的 <code>str</code> ，比如: <code>2008-09-15T15:53:00+05:00</code>。<ul>
<li>datetime.date：在请求和响应中将表示为 ISO 8601 格式的 <code>str</code> ，比如: <code>2008-09-15</code>。</li>
</ul>
</li>
<li>Decimal：在请求和相应中被当做 <code>float</code> 一样处理。</li>
</ul>
<p>更多额外的内置数据类型，可查询Pydantic文档<a target="_blank" rel="noopener" href="https://pydantic-docs.helpmanual.io/usage/types/">https://pydantic-docs.helpmanual.io/usage/types/</a></p>
<h3 id="请求头部"><a href="#请求头部" class="headerlink" title="请求头部"></a>请求头部</h3><p>要实现对FastAPI接口的请求头部进行发送相关内容的话，需要导入fastapi包下的Header函数。</p>
<p>在接口参数下，定义需要对头部定义参数即可，如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Union
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Header

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/header/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>admin_token<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> Header<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"admin-token"</span><span class="token punctuation">:</span> admin_token<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：大多数标准的headers用 “连字符” 分隔，也称为 “减号” (<code>-</code>)。</p>
<p>但是像 <code>user-agent</code> 这样的变量在Python中是无效的。</p>
<p>因此, 默认情况下, <strong><code>Header</code> 将把参数名称的字符从下划线 (<code>_</code>) 转换为连字符 (<code>-</code>) 来提取并记录 headers。</strong></p>
<p>同时，HTTP headers 是大小写不敏感的，因此，因此可以使用标准Python样式(也称为 “snake_case”)声明它们。因此，您可以像通常在Python代码中那样使用 <code>user_agent</code> ，而不需要将首字母大写为 <code>User_Agent</code> 或类似的东西。</p>
<h3 id="响应模型"><a href="#响应模型" class="headerlink" title="响应模型"></a>响应模型</h3><p>前面我们创建了请求模型，它是用作封装请求接口的。</p>
<p>而对于有些响应返回的类型我们在项目中通常也会将其封装，称为响应模型。</p>
<p>它的创建方法和请求模型一样，都是继承与BaseModel类。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ResultItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">10.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当它直接被用作返回时，也不会被有检验效果。需要在对应请求接口注解上的response_model进行配置：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>xxx<span class="token punctuation">:</span>xxx<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment"># item是一个Item类的实例对象</span>
    <span class="token keyword">return</span> item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有时，为了简便，通常用一个BaseModel既做 请求模型 又做 响应模型。但出现一个隐私问题，比如某个BaseModel中存在一些隐私数据的话，像用户注册时输入的密码，直接返回整个相同的BaseModel是十分不安全的。</p>
<p>对于隐私数据，可以在接口请求注解上使用<code>response_model_exclude</code>来排除某个指定的参数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    tax<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">10.5</span>


items <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"foo"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">50.2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"bar"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The Bar fighters"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token string">"tax"</span><span class="token punctuation">:</span> <span class="token number">20.2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"baz"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Baz"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my baz"</span><span class="token punctuation">,</span>
        <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">50.2</span><span class="token punctuation">,</span>
        <span class="token string">"tax"</span><span class="token punctuation">:</span> <span class="token number">10.5</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;/public"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">,</span> response_model_exclude<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"tax"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item_public_data</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回的响应数据不一定需要相同类，FastAPI的响应模型只是输出内部对应的数据：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UserIn</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span>
    full_name<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">class</span> <span class="token class-name">UserOut</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    full_name<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/user/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>UserOut<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>user_in<span class="token punctuation">:</span> UserIn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> user_in<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述返回的类型在函数内部是一个 UserIn对象结构，但是返回结果为 UserOut对象结构。</p>
<h3 id="表单数据请求"><a href="#表单数据请求" class="headerlink" title="表单数据请求"></a>表单数据请求</h3><p>在有时接口接收的不是Json数据，而是Form表单数据，或者上传文件的接口，这时需要用到Form配置。</p>
<p>要使用表单配置，需预先安装 <a target="_blank" rel="noopener" href="https://andrew-d.github.io/python-multipart/"><code>python-multipart</code></a>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Form

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/login/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Form<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Form<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建表单（<code>Form</code>）参数的方式与 <code>Body</code> 和 <code>Query</code> 一样。</p>
<p>例如，OAuth2 规范的 “密码流” 模式规定要通过表单字段发送 <code>username</code> 和 <code>password</code>。该规范要求字段必须命名为 <code>username</code> 和 <code>password</code>，并通过表单字段发送，不能用 JSON。使用 <code>Form</code> 可以声明与 <code>Body</code> （及 <code>Query</code>、<code>Path</code>、<code>Cookie</code>）相同的元数据和验证。</p>
<p>可在一个<em>路径操作</em>中声明多个 <code>Form</code> 参数，但不能同时声明要接收 JSON 的 <code>Body</code> 字段。因为此时请求体的编码是 <code>application/x-www-form-urlencoded</code>，不是 <code>application/json</code>。</p>
<blockquote>
<p>表单数据的「媒体类型」编码一般为 <code>application/x-www-form-urlencoded</code>。</p>
<p>但包含文件的表单编码为 <code>multipart/form-data</code>。</p>
</blockquote>
<h3 id="上传文件请求"><a href="#上传文件请求" class="headerlink" title="上传文件请求"></a>上传文件请求</h3><p>要实现上传文件的请求，和表单数据请求一样，需要需预先安装 <a target="_blank" rel="noopener" href="https://andrew-d.github.io/python-multipart/"><code>python-multipart</code></a>。</p>
<p>从 <code>fastapi</code> 导入 <code>File</code> 和 <code>UploadFile</code>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> File<span class="token punctuation">,</span> UploadFile

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/files/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> <span class="token builtin">bytes</span> <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"file_size"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/uploadfile/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_upload_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>声明文件体必须使用 <code>File</code>，否则，FastAPI 会把该参数当作查询参数或请求体（JSON）参数。</p>
<p>其中 <code>File()</code>文件作为「表单数据」上传。如果把<em>路径操作函数</em>参数的类型声明为 <code>bytes</code>，<strong>FastAPI</strong> 将以 <code>bytes</code> 形式读取和接收文件内容。<strong>这种方式把文件的所有内容都存储在内存里，适用于小型文件。</strong></p>
<p>而 <code>UploadFile</code>则是使用<code>spooled</code> 文件，它在存储到内存的文件超出最大上限时，FastAPI 会把文件存入磁盘，所以UploadFile 能上传更大文件，并且它可获取上传文件的元数据。</p>
<p>大多数情况下，<code>UploadFile</code> 更好使用。</p>
<p><code>UploadFile</code> 的属性有如下：</p>
<ul>
<li><code>filename</code>：上传文件名字符串（<code>str</code>），例如， <code>myimage.jpg</code>；</li>
<li><code>content_type</code>：内容类型（MIME 类型 / 媒体类型）字符串（<code>str</code>），例如，<code>image/jpeg</code>；</li>
<li><code>file</code>： <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/tempfile.html#tempfile.SpooledTemporaryFile"><code>SpooledTemporaryFile</code></a>（ <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/glossary.html#term-file-like-object">file-like</a> 对象）。其实就是 Python文件，可直接传递给其他预期 <code>file-like</code> 对象的函数或支持库。</li>
</ul>
<p><code>UploadFile</code> 支持以下 <code>async</code> 方法，（使用内部 <code>SpooledTemporaryFile</code>）可调用相应的文件方法：</p>
<ul>
<li><code>write(data)</code>：把 <code>data</code> （<code>str</code> 或 <code>bytes</code>）写入文件；</li>
<li><code>read(size)</code>：按指定数量的字节或字符（<code>size</code> (<code>int</code>)）读取文件内容；</li>
<li><code>seek(offset)</code>：移动至文件 <code>offset</code> （<code>int</code>）字节处的位置；<ul>
<li>例如，<code>await myfile.seek(0)</code> 移动到文件开头；</li>
<li>执行 <code>await myfile.read()</code> 后，需再次读取已读取内容时，这种方法特别好用；</li>
</ul>
</li>
<li><code>close()</code>：关闭文件。</li>
</ul>
<p>上述方法都是 <code>async</code> 方法，要搭配「await」使用。</p>
<p>例如，在 <code>async</code> <em>路径操作函数</em> 内，要用以下方式读取文件内容：</p>
<pre class="line-numbers language-none"><code class="language-none">contents &#x3D; await myfile.read()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在普通 <code>def</code> <em>路径操作函数</em> 内，则可以直接访问 <code>UploadFile.file</code>，例如：</p>
<pre class="line-numbers language-none"><code class="language-none">contents &#x3D; myfile.file.read()<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h4><p>FastAPI 支持同时上传多个文件。</p>
<p>对于多文件上传，将其封装到List内即可：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/files/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_files</span><span class="token punctuation">(</span>files<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">]</span> <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"file_sizes"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">]</span><span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/uploadfiles/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_upload_files</span><span class="token punctuation">(</span>files<span class="token punctuation">:</span> List<span class="token punctuation">[</span>UploadFile<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"filenames"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="抛出错误"><a href="#抛出错误" class="headerlink" title="抛出错误"></a>抛出错误</h3><h4 id="抛出普通浏览器错误"><a href="#抛出普通浏览器错误" class="headerlink" title="抛出普通浏览器错误"></a>抛出普通浏览器错误</h4><p>当接口出现输入情况下，往往会出现响应的错误状态，如404Not Find等等。</p>
<p>我们可以手动抛出对应的错误状态，只需要使用导入fastapi下的 <code>HTTPException</code>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> HTTPException

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

items <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"foo"</span><span class="token punctuation">:</span> <span class="token string">"The Foo Wrestlers"</span><span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Item not found"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"item"</span><span class="token punctuation">:</span> items<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>status_code</code>下可以设置响应的浏览器错误码，<code>detail</code>则是错误时返回的Json内容，它接受的是任何可以被Json格式化的数据类型，不只是str。</p>
<h4 id="抛出自定义错误"><a href="#抛出自定义错误" class="headerlink" title="抛出自定义错误"></a>抛出自定义错误</h4><p>大多数情况下，在项目中都是抛出自定义的错误，而不是浏览器错误。</p>
<p>对此需要先定义一个自定义错误模型：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UnicornException</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>fastApi需要定义一个全局错误拦截器，捕捉到这个定义的自定义错误，并进行相应处理：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>exception_handler</span><span class="token punctuation">(</span>UnicornException<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">unicorn_exception_handler</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> exc<span class="token punctuation">:</span> UnicornException<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span><span class="token number">418</span><span class="token punctuation">,</span>
        content<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Oops! </span><span class="token interpolation"><span class="token punctuation">&#123;</span>exc<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> did something. There goes a rainbow..."</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述捕捉到自定义错误后返回了一个指定格式的JSON，并设置了状态码为418。其中上述的Request、JSONResponse都是可以使用starlette包下的内容，它会fastapi中的内容一样。</p>
<p>最后当接口函数中抛出这个自定义异常即可触发相应处理：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/unicorns/&#123;name&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_unicorn</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">"yolo"</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> UnicornException<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"unicorn_name"</span><span class="token punctuation">:</span> name<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="路径操作配置"><a href="#路径操作配置" class="headerlink" title="路径操作配置"></a>路径操作配置</h3><p>在接口请求注解上，除了定义必须的 请求路径外，还可以配置各种信息，作用于接口。</p>
<h4 id="返回状态"><a href="#返回状态" class="headerlink" title="返回状态"></a>返回状态</h4><p><code>status_code</code> 用于定义<em>路径操作</em>响应中的 HTTP 状态码。可以直接传递 <code>int</code> 代码， 比如 <code>404</code>。也可以使用<code>status</code> 的快捷常量：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> status

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">,</span> status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_201_CREATED<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>状态码在响应中返回，并会被添加到 OpenAPI 概图。</p>
<p><strong>FastAPI</strong> 的<code>fastapi.status</code> 和 <code>starlette.status</code> 一样，只是快捷方式。</p>
<h4 id="接口分类"><a href="#接口分类" class="headerlink" title="接口分类"></a>接口分类</h4><p>在接口设置<code>tags</code> 参数，对接口进行分类，规范化接口文档。</p>
<p><code>tags</code> 参数的值是由 <code>str</code> 组成的 <code>list</code> （一般只有一个 <code>str</code> ）。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"items"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/20220531.png"></p>
<h4 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h4><p>使用<code>summary</code>、<code>description</code>可以对接口进行声明。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span>
    <span class="token string">"/items/"</span><span class="token punctuation">,</span>
    response_model<span class="token operator">=</span>Item<span class="token punctuation">,</span>
    summary<span class="token operator">=</span><span class="token string">"Create an item"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Create an item with all the information, name, description, price, tax and a set of unique tags"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>summary</code>： 接口标题 、<code>description</code>：接口说明</p>
<p>当其中description说明描述非常长的时候，可以考虑使用<code>docstring</code>，它支持多段文字，以及支持 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Markdown">Markdown</a>，能正确解析和显示 Markdown 的内容，但要注意文档字符串的缩进。它的用法就是在函数内容开头以三个引号开始“”“，三个引号结束，中间进行描述。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token string">"Create an item"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create an item with all the information:

    - **name**: each item must have a name
    - **description**: a long description
    - **price**: required
    - **tax**: if the item doesn't have tax, you can omit this
    - **tags**: a set of unique tag strings for this item
    """</span>
    <span class="token keyword">return</span> item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/202205312.png"></p>
<h3 id="Json转换"><a href="#Json转换" class="headerlink" title="Json转换"></a>Json转换</h3><p>在某些情况下，您可能需要将数据类型（如 Pydantic 模型）转换为与 JSON 兼容的类型（如<code>dict</code>、<code>list</code>等）。</p>
<p>FastApi内置了一个JSON转换器 - <code>jsonable_encoder()</code>，使用它可以将其自己的数据类型转换为与JSON兼容的数据类型。它的作用是将其数据内部的不可转换的数据类型（比如datetime）转换为Str格式。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>encoders <span class="token keyword">import</span> jsonable_encoder

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_item</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_compatible_item_data <span class="token operator">=</span> jsonable_encoder<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    fake_db<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> json_compatible_item_data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它不会直接转换为JSON的字符串，而是转换为list、dict这种兼容JSON的数据类型。</p>
<h3 id="自定义响应"><a href="#自定义响应" class="headerlink" title="自定义响应"></a>自定义响应</h3><p>对于RestFul的接口，往往会返回一个Result JSON作为请求的响应。</p>
<p>Result的格式一般为请求状态码、响应信息、返回数据这三个内容。</p>
<p>对于FastAPI来说需要定义自定义响应模型，通常在Pydantic模型下文件夹创建一个<code>resp.py</code>用作存储自定义响应模型：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""

统一响应状态码

"""</span>
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> status <span class="token keyword">as</span> http_status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse<span class="token punctuation">,</span> Response
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>encoders <span class="token keyword">import</span> jsonable_encoder

<span class="token keyword">class</span> <span class="token class-name">Resp</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> code<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> status
        self<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg
        self<span class="token punctuation">.</span>code <span class="token operator">=</span> code

    <span class="token keyword">def</span> <span class="token function">set_msg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg
        <span class="token keyword">return</span> self


InvalidRequest<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"无效的请求"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
InvalidParams<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">"无效的参数"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
BusinessError<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">"业务错误"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
DataNotFound<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1004</span><span class="token punctuation">,</span> <span class="token string">"查询失败"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
DataStoreFail<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1005</span><span class="token punctuation">,</span> <span class="token string">"新增失败"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
DataUpdateFail<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1006</span><span class="token punctuation">,</span> <span class="token string">"更新失败"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
DataDestroyFail<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1007</span><span class="token punctuation">,</span> <span class="token string">"删除失败"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_400_BAD_REQUEST<span class="token punctuation">)</span>
PermissionDenied<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">1008</span><span class="token punctuation">,</span> <span class="token string">"权限拒绝"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">)</span>
ServerError<span class="token punctuation">:</span> Resp <span class="token operator">=</span> Resp<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">"服务器繁忙"</span><span class="token punctuation">,</span> http_status<span class="token punctuation">.</span>HTTP_500_INTERNAL_SERVER_ERROR<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> pagination<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  msg<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"success"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>http_status<span class="token punctuation">.</span>HTTP_200_OK<span class="token punctuation">,</span>
        content<span class="token operator">=</span>jsonable_encoder<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token string">'msg'</span><span class="token punctuation">:</span> msg<span class="token punctuation">,</span>
            <span class="token string">'data'</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span>
            <span class="token string">'pagination'</span><span class="token punctuation">:</span> pagination
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fail</span><span class="token punctuation">(</span>resp<span class="token punctuation">:</span> Resp<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>resp<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        content<span class="token operator">=</span>jsonable_encoder<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token string">'status'</span><span class="token punctuation">:</span> resp<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
            <span class="token string">'msg'</span><span class="token punctuation">:</span> resp<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的返回类型为<code>Response</code>，<code>Response</code> 类接受如下参数：</p>
<ul>
<li><code>content</code> - 一个 <code>str</code> 或者 <code>bytes</code>。</li>
<li><code>status_code</code> - 一个 <code>int</code> 类型的 HTTP 状态码。</li>
<li><code>headers</code> - 一个由字符串组成的 <code>dict</code>。</li>
<li><code>media_type</code> - 一个给出媒体类型的 <code>str</code>，比如 <code>&quot;text/html&quot;</code>。</li>
</ul>
<p>这里由JSONResponse函数生成相应的返回值。</p>
<p>所以这里的响应体中的 <code>status_code</code>是指的浏览器响应状态码，而content内的<code>status</code>是请求状态码。</p>
<p>在请求接口中 返回使用即可：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/"</span><span class="token punctuation">,</span>summary<span class="token operator">=</span><span class="token string">"查询所有用户"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_users</span><span class="token punctuation">(</span>skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    users <span class="token operator">=</span> user_dao<span class="token punctuation">.</span>get_all_users<span class="token punctuation">(</span>db<span class="token punctuation">,</span> skip<span class="token operator">=</span>skip<span class="token punctuation">,</span> limit<span class="token operator">=</span>limit<span class="token punctuation">)</span>
    userList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> useronde <span class="token keyword">in</span> users<span class="token punctuation">:</span>
        usersd <span class="token operator">=</span> user<span class="token punctuation">.</span>User<span class="token punctuation">.</span>from_orm<span class="token punctuation">(</span>useronde<span class="token punctuation">)</span>
        userList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>usersd<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>ok<span class="token punctuation">(</span>data<span class="token operator">=</span>userList<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h3><p><strong>FastAPI</strong> 提供了多种工具，可帮助你以标准的方式轻松、快速地处理<strong>安全性</strong>，而无需研究和学习所有的安全规范。</p>
<p>FastAPI 在 <code>fastapi.security</code> 模块中为每个安全方案提供了几种工具，这些工具简化了这些安全机制的使用方法。</p>
<p>为此我们学习使用OAuth2方式进行安全认证：</p>
<p>实现要实现启动OAuth2认证前，让我们来看一些小的概念：</p>
<h4 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h4><p>OAuth2是一个规范，它定义了几种处理身份认证和授权的方法。</p>
<p>它是一个相当广泛的规范，涵盖了一些复杂的使用场景。</p>
<p>它包括了使用「第三方」进行身份认证的方法。</p>
<p>这就是所有带有「使用 Facebook，Google，Twitter，GitHub 登录」的系统背后所使用的机制。</p>
<h4 id="实现OAuth2"><a href="#实现OAuth2" class="headerlink" title="实现OAuth2"></a>实现OAuth2</h4><p>使用“表单数据”来发送<code>username</code>and <code>password</code>，<strong>OAuth2</strong>来判断用户输入的账户和密码是否正确。如果正确就返回Token给请求方，请求方再用这个Token给其它需要认证的接口来进行操作。</p>
<p>由于这里涉及使用到表单数据，所以就项目中需要安装<a target="_blank" rel="noopener" href="https://andrew-d.github.io/python-multipart/"><code>python-multipart</code></a>.</p>
<p>在fastapi.security包中导入OAuth2PasswordBearer：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<span class="token punctuation">,</span> FastAPI
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>security <span class="token keyword">import</span> OAuth2PasswordBearer

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

oauth2_scheme <span class="token operator">=</span> OAuth2PasswordBearer<span class="token punctuation">(</span>tokenUrl<span class="token operator">=</span><span class="token string">"token"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>oauth2_scheme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"token"</span><span class="token punctuation">:</span> token<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的tokenUrl 则是定义其认证头部名，这里定义为token。</p>
<p>这样项目就完成了初步安全加密了，运行后发现：</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image01.png"></p>
<p>您的<em>路径操作</em>上右上角多了一个小锁，您可以单击它，它有一个小授权表格来输入一个<code>username</code>和<code>password</code>（和其他可选字段），表示用来授权登录操作。</p>
<p>当然这里由于只设置了 认证要求，但没设置认证方法，所以这里并不能完成认证。</p>
<h4 id="设置认证方法"><a href="#设置认证方法" class="headerlink" title="设置认证方法"></a>设置认证方法</h4><p>上面只是展示了开启OAuth2认证的步骤，但是并没有编写认证方法。这里来进行编写认证方法：</p>
<p>所谓认证方法，就是用户认证登录的操作，在FastAPI的OAuth2认证中，默认以<code>/token</code>作为其认证方法路径，也就是说当用户登录时上传的路径其实是这个路径。</p>
<p>OAuth2的认证方法入参参数类型为<code>OAuth2PasswordRequestForm</code>，所以首先，导入 <code>OAuth2PasswordRequestForm</code>，然后在 <code>token</code> 的<em>路径操作</em>中通过 <code>Depends</code> 将其作为依赖项使用。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>security <span class="token keyword">import</span> OAuth2PasswordBearer<span class="token punctuation">,</span> OAuth2PasswordRequestForm

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>OAuth2PasswordRequestForm</code> 是一个类依赖项，声明了如下的请求表单：</p>
<ul>
<li><code>username</code>。</li>
<li><code>password</code>。</li>
<li>一个可选的 <code>scope</code> 字段，是一个由空格分隔的字符串组成的大字符串。</li>
<li>一个可选的 <code>grant_type</code>.</li>
<li>一个可选的 <code>client_id</code></li>
<li>一个可选的 <code>client_secret</code></li>
</ul>
<p>一般情况下，用户只需要传入<code>username</code>和<code>password</code>即可。</p>
<p>认证方法中内容则是 对于用户输入的信息进行认证。一般步骤有：</p>
<ol>
<li>根据用户输入的<code>username</code>在数据库中寻找是否存在，如果存在则继续，如果不存在就返回输入错误给用户。</li>
<li>根据用户输入的<code>password</code>来与 数据库查询到的用户进行对比，如果相同则登录成功，返回用户信息。如果不相同，则返回输入错误给用户。</li>
</ol>
<p>当然这个步骤在实际生产环境下禁止使用，因为里面的信息并不是加密信息，实际环境下数据库中不可能用明文存储密码的。当然这是下部分考虑的，目前先看下简单的操作。</p>
<p>这里我们用dict来创建一个”假的数据库”：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fake_users_db <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"johndoe"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"johndoe"</span><span class="token punctuation">,</span>
        <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"johndoe@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"hashed_password"</span><span class="token punctuation">:</span> <span class="token string">"fakehashedsecret"</span><span class="token punctuation">,</span>
        <span class="token string">"disabled"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"alice"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"alice"</span><span class="token punctuation">,</span>
        <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"Alice Wonderson"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"alice@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"hashed_password"</span><span class="token punctuation">:</span> <span class="token string">"fakehashedsecret2"</span><span class="token punctuation">,</span>
        <span class="token string">"disabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的拥有两个用户，其中<code>hashed_password</code>字段存储的是经过加密的密码（当然这里只是在密码前加了fakehashed，实际上不可能这样）。</p>
<p>随后我们创建一个用户模型：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    email<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    full_name<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    disabled<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        
<span class="token keyword">class</span> <span class="token class-name">UserInDB</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hashed_password<span class="token punctuation">:</span> <span class="token builtin">str</span>        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个User模型这里主要是用来登录成功返回用户信息的，它跟数据库中的字段是有差别的，没有敏感信息（比如密码），因为我们在登录成功后返回用户信息中，不能直接将密码返回给Response中，这是不安全的。</p>
<p>而UserInDB则是在此阶段多个敏感字段（这里指密码）。</p>
<p>创建完模型后，就可以在认证方法中编写从数据库中获取用户的信息步骤：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_dict <span class="token operator">=</span> fake_users_db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>form_data<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_dict<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Incorrect username or password"</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> UserInDB<span class="token punctuation">(</span><span class="token operator">**</span>user_dict<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这儿<code>UserInDB(**user_dict)</code>将其获取到的user_dict用户信息内容设置到了UserInDB对象中。</p>
<p>编写加密方式函数，用作对用户输入的密码进行加密操作：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fake_hash_password</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"fakehashed"</span> <span class="token operator">+</span> password<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在认证方法中将其用户输入的密码与数据库中的密码进行对比，最后返回指定信息即完成认证方法的编写。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_dict <span class="token operator">=</span> fake_users_db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>form_data<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_dict<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Incorrect username or password"</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> UserInDB<span class="token punctuation">(</span><span class="token operator">**</span>user_dict<span class="token punctuation">)</span>
    hashed_password <span class="token operator">=</span> fake_hash_password<span class="token punctuation">(</span>form_data<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> hashed_password <span class="token operator">==</span> user<span class="token punctuation">.</span>hashed_password<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Incorrect username or password"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"access_token"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token string">"token_type"</span><span class="token punctuation">:</span> <span class="token string">"bearer"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里返回的响应必须是一个 JSON 对象。它应该有一个 <code>token_type</code>。在我们的例子中，由于我们使用的是「Bearer」令牌，因此令牌类型应为「<code>bearer</code>」。并且还应该有一个 <code>access_token</code> 字段，它是一个包含我们的访问令牌的字符串。这时FastAPI中的OAuth2的定义规范。</p>
<p>当然对于这个简单的示例，我们将极其不安全地返回相同的 <code>username</code> 作为令牌。</p>
<h4 id="设置认证判断"><a href="#设置认证判断" class="headerlink" title="设置认证判断"></a>设置认证判断</h4><p>上面我们编写了认证方法，用户在认证中成功认证后，将返回用户的名称作为 认证口令。</p>
<p>但是这只是认证方法，对于需要认证的 接口而言 并不起作用，因为它们不知道怎么判断是否认证。所以我们还需要编写认证判断的代码。</p>
<p>假设，我们编写了一个<code>read_users_me</code> 接口，它需要根据当前认证的用户返回认证用户的信息，如果没有认证，则报错：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/me"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_users_me</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> current_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对于这个我们需要编写一个获取当前用户的函数作为依赖项：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>oauth2_scheme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> fake_decode_token<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"Invalid authentication credentials"</span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它接收一个Token字符串（这里指定了oauth2_scheme依赖项，表明是从头部定义的内容获取），其中fake_decode_token函数为从数据库中获取定义用户信息：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> username <span class="token keyword">in</span> db<span class="token punctuation">:</span>
        user_dict <span class="token operator">=</span> db<span class="token punctuation">[</span>username<span class="token punctuation">]</span>
        <span class="token keyword">return</span> UserInDB<span class="token punctuation">(</span><span class="token operator">**</span>user_dict<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">fake_decode_token</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This doesn't provide any security at all</span>
    <span class="token comment"># Check the next version</span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>fake_users_db<span class="token punctuation">,</span> token<span class="token punctuation">)</span>
    <span class="token keyword">return</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际上和认证方法中的 第一步 是一样的效果。</p>
<p>我们在需要认证的接口上的参数中注入get_current_user这个依赖项即可完成认证判断：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/me"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_users_me</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> current_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>运行项目，点击「Authorize」按钮。在<code>username</code>中输入johndoe，<code>password</code>中输入<code>secret</code>，点击Authorize登录。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image04.png"></p>
<p>在系统中进行身份认证后，你将看到：</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image05.png"></p>
<p>执行 <code>/users/me</code> 路径的 <code>GET</code> 操作，这时就会返回当前登入的用户信息了。</p>
<p>其实在执行 <code>/users/me</code> 路径操作时，OpenAPI文档就已经变相将其口令传入到头部中了，实际前后分离中 前端操作中需要手动在头部中传入登录返回的的口令，才能判断认证。比如这里在OAuth2PasswordBearer中设置的是 token，所以请求头部 就应该有一个“token”头部内容。</p>
<h4 id="实现JWT以及Hash加密认证"><a href="#实现JWT以及Hash加密认证" class="headerlink" title="实现JWT以及Hash加密认证"></a>实现JWT以及Hash加密认证</h4><p>前面的案例中只是普通固定字符串加密，在实际生成环境中需要对密码信息等用到Hash加密，否则无法保证安全性。</p>
<h5 id="Hash加密"><a href="#Hash加密" class="headerlink" title="Hash加密"></a>Hash加密</h5><p>对于Python 实现Hash加密，推荐使用PassLib ，它支持多种Hash加密算法，这里推荐的算法是 「Bcrypt」，所以还需要安装Bcrypt。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ pip <span class="token function">install</span> passlib
$ pip <span class="token function">install</span> bcrypt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>通过使用passlib.context包的<code>CryptContext</code> 函数，我们可以实现加密、解密。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> passlib<span class="token punctuation">.</span>context <span class="token keyword">import</span> CryptContext
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># passlib使用bcrypt算法</span>
pwd_context <span class="token operator">=</span> CryptContext<span class="token punctuation">(</span>schemes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"bcrypt"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deprecated<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">)</span>

<span class="token comment"># 判断密码正确性</span>
<span class="token comment"># pwd_context.verify接受 一个 未加密密码、一个加密密码，若加密相同则返回真</span>
<span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>plain_password<span class="token punctuation">,</span> hashed_password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span>verify<span class="token punctuation">(</span>plain_password<span class="token punctuation">,</span> hashed_password<span class="token punctuation">)</span>

<span class="token comment"># 加密密码</span>
<span class="token keyword">def</span> <span class="token function">get_password_hash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span><span class="token builtin">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们只需要在其前面例子中的认证方法中的进行修改即可实现加密密码认证。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fake_users_db <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"johndoe"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"johndoe"</span><span class="token punctuation">,</span>
        <span class="token string">"full_name"</span><span class="token punctuation">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"johndoe@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"hashed_password"</span><span class="token punctuation">:</span> <span class="token string">"$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW"</span><span class="token punctuation">,</span>
        <span class="token string">"disabled"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># 融合数据库获取用户信息 和 密码比对两个操作步骤</span>
<span class="token keyword">def</span> <span class="token function">authenticate_user</span><span class="token punctuation">(</span>fake_db<span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>fake_db<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> verify_password<span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashed_password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> user

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Token<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login_for_access_token</span><span class="token punctuation">(</span>form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> authenticate_user<span class="token punctuation">(</span>fake_users_db<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>username<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除了对密码进行Hash加密之外，在安全上 还需要使用JWT口令作为token的传值。</p>
<h5 id="关于-JWT"><a href="#关于-JWT" class="headerlink" title="关于 JWT"></a>关于 JWT</h5><p>JWT全程为JSON Web Tokens。它是一个将 JSON 对象进行编码且没有空格的长字符串的标准。字符串看起来像这样：</p>
<pre class="line-numbers language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQsswc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它虽然是一段字符串，但是它包含了JSON内容以及一些特殊数据，这些将其反编译后就可以取得。</p>
<p>之所以使用JWT作为返回内容，而不是JSON，是因为它更小，并且可以设置有效时间，当有效时间过期则无法使用，所有具有一定安全性。</p>
<p>整个流程中 我们在登录成功后 将其用户的信息 加密为JWT，然后用户在请求时携带上JWT，再将其解码来判断身份。</p>
<h5 id="JWT实现"><a href="#JWT实现" class="headerlink" title="JWT实现"></a>JWT实现</h5><p>需要安装 <code>python-jose</code> 以在 Python 中生成和校验 JWT 令牌：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ pip <span class="token function">install</span> python-jose<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中 <code>python-jose</code> 需要一个额外的加密后端 依赖，这里我们使用的是推荐的后端：<a target="_blank" rel="noopener" href="https://cryptography.io/">cryptography</a>。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ pip <span class="token function">install</span> cryptography<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在生成JWT之前需要一个随机的安全密匙，相当于门锁钥匙，它依赖匹配对应的JWT（门锁）。</p>
<p>要生成一个安全的随机密钥，可使用以下命令：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ openssl rand -hex <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在项目中定义一个变量 「SECRET_KEY」，然后把它用在里面（这里是随机的内容，不要无脑复制）。</p>
<p>还要创建用于设定 JWT 令牌签名算法的变量 「ALGORITHM」，并将其设置为 <code>&quot;HS256&quot;</code>。</p>
<p>以及创建一个设置令牌过期时间的变量。</p>
<p>定义一个将在令牌端点中用于响应的 Pydantic 模型，用作认证后的返回模型。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> jose <span class="token keyword">import</span> JWTError<span class="token punctuation">,</span> jwt

SECRET_KEY <span class="token operator">=</span> <span class="token string">"09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"</span>
ALGORITHM <span class="token operator">=</span> <span class="token string">"HS256"</span>
ACCESS_TOKEN_EXPIRE_MINUTES <span class="token operator">=</span> <span class="token number">30</span>

<span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    access_token<span class="token punctuation">:</span> <span class="token builtin">str</span>
    token_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建一个生成新的访问令牌的工具函数。 </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_access_token</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> expires_delta<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>timedelta<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    to_encode <span class="token operator">=</span> data<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> expires_delta<span class="token punctuation">:</span>
        expire <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires_delta
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        expire <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
    to_encode<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"exp"</span><span class="token punctuation">:</span> expire<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    encoded_jwt <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>to_encode<span class="token punctuation">,</span> SECRET_KEY<span class="token punctuation">,</span> algorithm<span class="token operator">=</span>ALGORITHM<span class="token punctuation">)</span>
    <span class="token keyword">return</span> encoded_jwt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将它用用作在认证成功后的操作中，生成的JWT最后返回到<code>access_token</code>中：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Token<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login_for_access_token</span><span class="token punctuation">(</span>form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> authenticate_user<span class="token punctuation">(</span>fake_users_db<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>username<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"Incorrect username or password"</span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    access_token_expires <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>ACCESS_TOKEN_EXPIRE_MINUTES<span class="token punctuation">)</span>
    access_token <span class="token operator">=</span> create_access_token<span class="token punctuation">(</span>
        data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"sub"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> expires_delta<span class="token operator">=</span>access_token_expires
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"access_token"</span><span class="token punctuation">:</span> access_token<span class="token punctuation">,</span> <span class="token string">"token_type"</span><span class="token punctuation">:</span> <span class="token string">"bearer"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里设置JWT中JSON内容含有一个<code>sub</code>的键，存储着认证的用户名。</p>
<p>在其认证判断中根据这个JWT来进行解码，获取到认证的用户名：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TokenData</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>oauth2_scheme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    credentials_exception <span class="token operator">=</span> HTTPException<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
        detail<span class="token operator">=</span><span class="token string">"Could not validate credentials"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># JWT解码</span>
        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span>ALGORITHM<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取到JWT中的JSON内容的值</span>
        username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> username <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> credentials_exception
        token_data <span class="token operator">=</span> TokenData<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span>
    <span class="token keyword">except</span> JWTError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> credentials_exception
    <span class="token comment"># 根据数据库查询这个用户信息    </span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>fake_users_db<span class="token punctuation">,</span> username<span class="token operator">=</span>token_data<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> credentials_exception
    <span class="token keyword">return</span> user

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_active_user</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>disabled<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Inactive user"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> current_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>在实现了Hash加密和JWT后，运行整个项目。</p>
<p>像以前一样对应用程序进行认证。</p>
<p>使用如下凭证：</p>
<p>用户名: <code>johndoe</code> 密码: <code>secret</code></p>
<p>这时，它返回了一个Token对象，其中access_token字段为JWT内容，将其内容用在<code>/users/me/</code> 请求头部上，请求头名为“Authenticate”，便成功返回出认证的用户信息，注意 <code>Authorization</code> 首部 还需要 以 <code>Bearer</code> 开头。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image10.png"></p>
<p>这里只是简单的说明下其OAuth2在FastAPI的玩法，具体的还有Scope等权限控制方法，这个后面教程中再慢慢讲述，这里不做描述。</p>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p>FastAPI支持向请求中添加中间件，从而使请求执行前先执行中间件内容，类似于过滤器。</p>
<h4 id="创建中间件"><a href="#创建中间件" class="headerlink" title="创建中间件"></a>创建中间件</h4><p>要创建中间件你可以在中间件函数的顶部使用装饰器 <code>@app.middleware(&quot;http&quot;)</code>.</p>
<p>中间件函数接受两个函数：</p>
<ul>
<li><p><code>request</code>.</p>
</li>
<li><p>一个函数 <code>call_next</code></p>
<p>它将接收request作为参数.</p>
<ul>
<li>这个函数将 <code>request</code> 传递给相应的 <em>路径操作</em>.</li>
<li>然后它将返回由相应的<em>路径操作</em>生成的 <code>response</code>.</li>
</ul>
</li>
</ul>
<p>简而言之 call_next(request) 相当于等待执行 完请求内容。</p>
<p>比如我们创建一个运行时间计算中间件，它将记录请求 的运行速度，并将其返回到响应的头部。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Request

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>middleware</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_process_time_header</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    process_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Process-Time"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>process_time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于call_next(request) 相当于等待执行 完请求内容，所以使用它时务必带上 await。</p>
<h3 id="配置CORS"><a href="#配置CORS" class="headerlink" title="配置CORS"></a>配置CORS</h3><p>CORS又叫做 跨域资源共享，是当两个或者多个服务器进行相互请求时获取内容产生的过程。</p>
<p>在前后端分离下 ，前端服务器与后端服务器 有时会不在同一个服务器、同一个端口下，这时默认情况下前端浏览器不会允许请求来自另外一个后端服务器下的接口。要解决它，这个问题就是开发常常谈到的跨域设置。</p>
<p>浏览器在进行请求外部（非本服务器）的请求时就会自动在请求头部上进行加入“Origin”字段，这个字段将被认为请求发起方的来源。</p>
<p>FastAPI中是这样配置跨域设置的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword">import</span> CORSMiddleware

origins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span>

app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span>origins<span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中allow_origins表示允许的请求服务器地址，allow_methods、allow_headers表示允许的请求方法和请求头部。</p>
<p>其中<code>allow_credentials</code> - 表示指示跨域请求是否支持 cookies。默认是 <code>False</code>。另外，允许凭证时 <code>allow_origins</code> 不能设定为 <code>[&#39;*&#39;]</code>，必须指定源。</p>
<p>如果它们配置为’*’的话，表示所有条件都能被允许。</p>
<p>但是对于allow_origins设置的话，在一些情况下会固定设置地址，放置他人滥用。</p>
<h3 id="元数据和文档-URL"><a href="#元数据和文档-URL" class="headerlink" title="元数据和文档 URL"></a>元数据和文档 URL</h3><p>你可以在创建 <strong>FastAPI</strong>实例时 自定义几个元数据配置。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">description <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
ChimichangApp API helps you do awesome stuff. 🚀

## Items

You can **read items**.

## Users

You will be able to:

* **Create users** (_not implemented_).
* **Read users** (_not implemented_).
"""</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">"ChimichangApp"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span>description<span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
    terms_of_service<span class="token operator">=</span><span class="token string">"http://example.com/terms/"</span><span class="token punctuation">,</span>
    contact<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Deadpoolio the Amazing"</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://x-force.example.com/contact/"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"dp@x-force.example.com"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    license_info<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Apache 2.0"</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://www.apache.org/licenses/LICENSE-2.0.html"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最终，接口文档就会是这样：</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image101.png"></p>
<p>注意你可以在描述内使用 Markdown，例如「login」会显示为粗体（<strong>login</strong>）以及「fancy」会显示为斜体（<em>fancy</em>）。</p>
<p>除了对文档主页面的定义修改之外，还可以对单独的标签组进行定义：</p>
<p>在创建FastAPI下传入openapi_tags参数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">tags_metadata <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"users"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Operations with users. The **login** logic is also here."</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"items"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Manage items. So _fancy_ they have their own docs."</span><span class="token punctuation">,</span>
        <span class="token string">"externalDocs"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Items external docs"</span><span class="token punctuation">,</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://fastapi.tiangolo.com/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>openapi_tags<span class="token operator">=</span>tags_metadata<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Harry"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Ron"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"items"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"wand"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"flying broom"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>里面的<code>tags_metadata</code>是一个列表，其中name对应的是响应的组名（tags）。</p>
<p>如果你现在查看文档，它们会显示附加的元数据：</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/image102.png"></p>
<p>最开始时，讲到FastAPI将会自动生成两个用户接口文档，分别是SwaggerUI、ReDoc。</p>
<p>它们的默认地址分别是“/docs”和“/redoc”，对于它们的页面地址可以自定义，在创建FastAPI时传入<code>docs_url</code>、<code>redoc_url</code>参数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>docs_url<span class="token operator">=</span><span class="token string">"/swagger"</span><span class="token punctuation">,</span> redoc_url<span class="token operator">=</span><span class="token string">"/redoc"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="挂载静态资源"><a href="#挂载静态资源" class="headerlink" title="挂载静态资源"></a>挂载静态资源</h3><p>FastAPI支持挂载指定位置的静态资源。</p>
<p>虽然这在后端中并不是 非常常用，但是对于项目中指定文件可以通过这种方式直接访问。</p>
<p>导入<code>StaticFiles</code>（不管是fastapi包下的还是starlette包下的都可以），然后在FastAPI的实例后使用mount方法：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>staticfiles <span class="token keyword">import</span> StaticFiles

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span>mount<span class="token punctuation">(</span><span class="token string">"/static"</span><span class="token punctuation">,</span> StaticFiles<span class="token punctuation">(</span>directory<span class="token operator">=</span><span class="token string">"static"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"static"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>mount方法的第一个接受参数<code>&quot;/static&quot;</code>是指目录将被“挂载”到的服务器路径。因此，任何以它开头的路径<code>&quot;/static&quot;</code>都将由该目录映射。<code>directory=&quot;static&quot;</code>指包含您的静态文件的目录的名称。而<code>name=&quot;static&quot;</code>则是给它一个可以由<strong>FastAPI</strong>内部使用的名称。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>FastAPI提供了测试的方法。</p>
<p>它基于<a target="_blank" rel="noopener" href="https://www.starlette.io/testclient/">Starlette</a>，而Starlette 的测试由基于<a target="_blank" rel="noopener" href="https://requests.readthedocs.io/">Requests</a>。</p>
<p>FastAPI测试需要将于<a target="_blank" rel="noopener" href="https://docs.pytest.org/">pytest</a>一起使用。</p>
<h4 id="编写测试用例"><a href="#编写测试用例" class="headerlink" title="编写测试用例"></a>编写测试用例</h4><p>对于Python测试而言，测试文件名以<code>test_</code>开头。</p>
<p>比如我们现在拥有一个简简单单的<code>main.py</code>文件为例：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Union

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Header<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel

fake_secret_token <span class="token operator">=</span> <span class="token string">"coneofsilence"</span>

fake_db <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"foo"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my hero"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"bar"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The bartenders"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_main</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> x_token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Header<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> x_token <span class="token operator">!=</span> fake_secret_token<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid X-Token header"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> fake_db<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Item not found"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> fake_db<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">,</span> x_token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Header<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> x_token <span class="token operator">!=</span> fake_secret_token<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid X-Token header"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">in</span> fake_db<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Item already exists"</span><span class="token punctuation">)</span>
    fake_db<span class="token punctuation">[</span>item<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> item
    <span class="token keyword">return</span> item
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么我们测试它，创建一个<code>test_main.py</code>文件。</p>
<p>导入<code>TestClient</code>（Fastapi包和Starlette包中的都可以），<code>TestClient</code>通过传递您的<strong>FastAPI</strong>实例创建。</p>
<p>对于测试函数，名称以 开头的函数<code>test_</code>（这是标准<code>pytest</code>约定）。</p>
<p>使用<code>TestClient</code>对象的方式与使用<code>requests</code>方法一样。所以里面的内容为：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

<span class="token keyword">from</span> <span class="token punctuation">.</span>main <span class="token keyword">import</span> app

client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_read_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/foo"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my hero"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">test_read_item_bad_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/foo"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"hailhydra"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Invalid X-Token header"</span><span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">test_read_inexistent_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/baz"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">404</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Item not found"</span><span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">test_create_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo Bar"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The Foo Barters"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo Bar"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The Foo Barters"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">test_create_item_bad_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"hailhydra"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"bazz"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Bazz"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Drop the bazz"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Invalid X-Token header"</span><span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">test_create_existing_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">&#123;</span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"The Foo ID Stealers"</span><span class="token punctuation">,</span>
            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my stealer"</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Item already exists"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的测试方法主要是 通过使用get、post等请求手段获取到响应对象，再利用<code>assert</code>断言进行与 与其进行对比。</p>
<blockquote>
<p>注意测试功能是正常的<code>def</code>，不是<code>async def</code>。</p>
<p>并且对客户端的调用也是正常调用，而不是使用<code>await</code>.</p>
<p>这使您可以<code>pytest</code>直接使用而不会出现并发问题。</p>
<p>当然如果对于需要异步测试的情况下，就需要更深入的手段，具体后面再简绍。</p>
</blockquote>
<h4 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h4><p>要运行测试，就需要安装<code>pytest</code>:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ pip <span class="token function">install</span> pytest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装完毕后，在终端中输入：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ pytest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>pytest将自动寻找项目中的<code>test_</code>开头的py文件，进行测试。</p>
<p>当然对于单个测试文件运行 在后面加上具体文件路径即可。如果要使pytest只输出结果和错误的话，在后面加上<code>-q</code>参数，进入安静模式即可。</p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>在许多情况下，您的应用程序可能需要一些外部设置或配置，例如密钥、数据库凭证、电子邮件服务凭证等。</p>
<p>这些设置中的大多数都是可变的（可以更改），例如数据库 URL。许多人可能很敏感，比如秘密。</p>
<p>出于这个原因，通常在应用程序读取的环境变量中提供它们。</p>
<p>在FastAPI中可以将其需要设置为环境变量的数据创建为Pydantic模型，Pydantic 提供了一个BaseSettings类用作环境变量模型类。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseSettings


<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Awesome API"</span>
    admin_email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    items_per_user<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span>
        
settings <span class="token operator">=</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/info"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"app_name"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>app_name<span class="token punctuation">,</span>
        <span class="token string">"admin_email"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>admin_email<span class="token punctuation">,</span>
        <span class="token string">"items_per_user"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>items_per_user<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>值得注意的是环境变量模型中的属性名不区分大小写，也就是说这里的<code>settings.app_name</code>也可以写作<code>settings.APP_NAME</code>依然可以识别。</p>
<p>当然正常情况下你一般将配置模型放到一个独立的文件下，比如创建一个<code>config.py</code>:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseSettings


<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Awesome API"</span>
    admin_email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    items_per_user<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span>


settings <span class="token operator">=</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在需要使用的地方引用即可。</p>
<p>接下来，您运行应用时 将相关配置数据作为环境变量传入：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token assign-left variable">ADMIN_EMAIL</span><span class="token operator">=</span><span class="token string">"deadpool@example.com"</span> <span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span><span class="token string">"ChimichangApp"</span> uvicorn main:app<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>要为设置多个环境变量，只需将它们用空格分隔，并将它们全部放在运行命令之前。</p>
<p>当然上面这种做法对于几个配置设置是可行的，但是对于中大型项目来说，拥有的配置变量十分多，每次启动都进行单独输入十分不方便，而且容易出现错误。对于这种情况，往往采用使用外置配置文件来进行解决的。</p>
<p>在项目文件夹中创建一个<code>.env</code>文件，该文件称为“dotenv”，它是用来存储项目配置内容的文件，当每次项目启动后，读取该文件。</p>
<p>我们在项目根目录创建一个<code>.env</code>文件：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ADMIN_EMAIL<span class="token operator">=</span><span class="token string">"deadpool@example.com"</span>
APP_NAME<span class="token operator">=</span><span class="token string">"ChimichangApp"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后修改之前的<code>config.py</code>内容：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseSettings


<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"Awesome API"</span>
    admin_email<span class="token punctuation">:</span> <span class="token builtin">str</span>
    items_per_user<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span>

    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        env_file <span class="token operator">=</span> <span class="token string">".env"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里在Settings内部新增一个<code>Config</code>子类，在这里配置env文件路径。</p>
<p>并且删除了之前的<code>settings = Settings()</code>内容，删除它的原因就是每次使用时再进行实例化，而不是全局使用。</p>
<p>在使用配置数据的地方的代码是这样的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> lru_cache
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> config

<span class="token decorator annotation punctuation">@lru_cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span>Settings<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/info"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">info</span><span class="token punctuation">(</span>settings<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Settings <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"app_name"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>app_name<span class="token punctuation">,</span>
        <span class="token string">"admin_email"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>admin_email<span class="token punctuation">,</span>
        <span class="token string">"items_per_user"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>items_per_user<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里采用依赖项的方式进行注入到使用的地方上，并且使用了<code>@lru_cache()</code>这个注解。</p>
<p><code>@lru_cache()</code>的作用是 使该函数内部对象只实例化创建一次，后续使用全部重新调用。</p>
<p>之所以要使用这个功能，因为从磁盘读取文件通常是一项代价高昂（缓慢）的操作，对于配置文件内容往往只需要读取一次就可以了，减少处理时间。</p>
</div>

      <!-- Post Comments -->
      
    <!-- 使用 changyan -->
<div id="changyan-comment">
    <!--PC和WAP自适应版-->
<div id="SOHUCS" sid="2022/07/20/FastAPI/"  ></div>
<script type="text/javascript">
(function(){
var appid = 'cyvzq2tmJ';
var conf = 'e61bcf9ca7baef66559e7e33e21fe290';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

</div>
<style>
    #changyan-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

    </div>
    <!-- Copyright 版权 start -->
    <div id="copyright">
  <ul>
    <li>
      &copy;Powered By
      <a target="_blank" rel="noopener" href="https://hexo.io/" style="border-bottom: none">hexo</a>
    </li>
    <li>Author: <a style="border-bottom: none">@Zssaer</a></li>
  </ul>
  <ul>
    <li>
      <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" id="beian">蜀ICP备2021031070号</a>
    </li>
  </ul>
  
  <span id="busuanzi_container_site_pv"> 2024 </span>
  
</div>

  </div>
  <script>
    const originalTitle = document.title;
    document.title = `FastAPI教程` + `|` + originalTitle;
  </script>
</body>



 	
</html>
