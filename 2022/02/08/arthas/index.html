<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/favicon.png"/>
	<link rel="shortcut icon" href="/img/favicon.png">
	<meta name="baidu-site-verification" content="code-KLcpk3wnwR" />
	
			<title>趙天一ლ(ﾟдﾟლ)You know、You don’t know</title>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, user-scalable=no"
/>
<link rel="stylesheet" href="/css/mic_main.css" />
<link rel="stylesheet" href="/css/dropdownMenu.css" />
<!-- <script src="/js/live2d/autoload.js"></script> -->

<meta name="keywords" content="Zssaer JavaWeb TIANYI ZHAO" />

<noscript>
  <link rel="stylesheet" href="/css/noscript.css" />
</noscript>
<style type="text/css">
  /* body{
    background: url('https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-r7r551.jpg?x-oss-process=style/wallpaper') center 0 no-repeat;
    content: " ";
    position: fixed;
  } */
  body:before {
    content: " ";
    position: fixed;
    top: 0;
    background: url('https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-r7r551.jpg?x-oss-process=style/wallpaper') center 0 no-repeat;

    right: 0;
    bottom: 0;
    left: 0;
    background-size: cover;
  }
</style>

			    

    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.scrollex.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/jquery.scrolly.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/skel.min.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/util.js"></script>
    <script src="https://zssaer.oss-cn-chengdu.aliyuncs.com/main.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>
    
		<!-- Layouts -->


<!--  代码渲染  -->
<script src="/js/prism.js"></script>
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body
  class=""
  data-prismjs-copy="复制"
  data-prismjs-copy-error="请按Ctrl+C手动复制"
  data-prismjs-copy-success="复制成功!"
>
  <div class="mask-border"></div>
  <!-- Wrapper 外包 s-->
  <div id="wrapper" class="fade-in">
    <!-- Intro 头部显示 s -->
    <!-- Intro 头部显示 e -->
    <!-- Header 头部logo start -->
    <header id="header">
    <a href="/" class="logo">Refrain</a>
</header>
    <!-- Nav 导航条 start -->
    <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">Home</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">Categories</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/JAVA/">JAVA</a></li><li><a class="category-link" href="/categories/Python/">Python</a></li><li><a class="category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li><a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li><a class="category-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a></li><li><a class="category-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="AboutMe">
		                AboutMe
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="Wallpaper">
		                Wallpaper
		            </a>
		        </li>
		        
		        <li>
		            <a href="/bangumis/" title="Bangumis">
		                Bangumis
		            </a>
		        </li>
		        
						<li class="active">
							<a href="#s1">Other</a>
											<ul class="submenu">
													<li>
													<a class="category-link" href="/another/billiard.html">台球模拟V1.0</a>
												</li>
											</ul>
						</li>

            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/Zssaer" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="git" href="https://gitee.com/Zssaer01" target="_blank" rel="noopener">
                            <i class="icon fa fa-git"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>
    <aside id="toc_menu"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Arthas-Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7"><span class="toc-number">1.</span> <span class="toc-text">Arthas - Java诊断工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-number">1.2.</span> <span class="toc-text">使用范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Arthas"><span class="toc-number">1.3.1.</span> <span class="toc-text">启动Arthas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%80%E5%87%BAArthas"><span class="toc-number">1.3.2.</span> <span class="toc-text">退出Arthas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">在浏览器操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%9E%E6%97%B6%E9%9D%A2%E6%9D%BF"><span class="toc-number">1.3.4.</span> <span class="toc-text">获取当前程序的实时面板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.5.</span> <span class="toc-text">获取当前线程的进程操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91%E7%B1%BB"><span class="toc-number">1.3.6.</span> <span class="toc-text">反编译类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.7.</span> <span class="toc-text">在线执行代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">常见案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%95%E6%8D%89%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">捕捉错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">热代码更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8B%A6%E6%88%AA"><span class="toc-number">1.4.3.</span> <span class="toc-text">过滤器拦截</span></a></li></ol></li></ol></li></ol></aside>
    <div id="main">
      
      <div
        class="post_page_title_img"
        style="
          height: 25rem;
          background-image: url(https://zssaer.oss-cn-chengdu.aliyuncs.com/wallhaven-dpg19j.png?x-oss-process=style/wallpaper);
          background-position: center;
          background-repeat: no-repeat;
          background-size: cover;
          -moz-background-size: cover;
          overflow: hidden;
        "
      >
        <a href="#" style="padding: 4rem 4rem 2rem 4rem"
          ><h2 id="page-title">Arthas - Java诊断工具</h2></a
        >
      </div>
      
      <button id="toc_button" onclick="openTocSidebar()">文章导航</button>
      <!-- <div id="content_toc">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Arthas-Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7"><span class="toc-number">1.</span> <span class="toc-text">Arthas - Java诊断工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-number">1.2.</span> <span class="toc-text">使用范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Arthas"><span class="toc-number">1.3.1.</span> <span class="toc-text">启动Arthas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%80%E5%87%BAArthas"><span class="toc-number">1.3.2.</span> <span class="toc-text">退出Arthas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">在浏览器操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%9E%E6%97%B6%E9%9D%A2%E6%9D%BF"><span class="toc-number">1.3.4.</span> <span class="toc-text">获取当前程序的实时面板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.5.</span> <span class="toc-text">获取当前线程的进程操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91%E7%B1%BB"><span class="toc-number">1.3.6.</span> <span class="toc-text">反编译类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.7.</span> <span class="toc-text">在线执行代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">常见案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%95%E6%8D%89%E9%94%99%E8%AF%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">捕捉错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">热代码更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8B%A6%E6%88%AA"><span class="toc-number">1.4.3.</span> <span class="toc-text">过滤器拦截</span></a></li></ol></li></ol></li></ol>
            </div>     -->

      <!-- Post -->
      <div class="typo" style="padding: 3rem"><h1 id="Arthas-Java诊断工具"><a href="#Arthas-Java诊断工具" class="headerlink" title="Arthas - Java诊断工具"></a>Arthas - Java诊断工具</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/arthas.png"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas">Arthas</a>是Alibaba在Github上开源的Java诊断工具。</p>
<p>它和其他Java诊断工具一样，比如JDK官方的Jvisualvm，都能够进行在Java应用运行的后台中进行获取其状态。</p>
<p>不同其他的工具，Arthas更加简单方便，<code>Arthas</code>支持JDK 6+，支持Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 <code>Tab</code> 自动补全功能，进一步方便进行问题的定位和诊断。</p>
<h2 id="使用范围"><a href="#使用范围" class="headerlink" title="使用范围"></a>使用范围</h2><p>或许之前未接触到其他Java诊断工具，下面就是Arthas使用的场景：</p>
<blockquote>
<ol>
<li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li>
<li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li>
<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li>
<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>
<li>是否有一个全局视角来查看系统的运行状况？</li>
<li>有什么办法可以监控到JVM的实时运行状态？</li>
<li>怎么快速定位应用的热点，生成火焰图？</li>
<li>怎样直接从JVM内查找某个类的实例？</li>
</ol>
</blockquote>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="启动Arthas"><a href="#启动Arthas" class="headerlink" title="启动Arthas"></a>启动Arthas</h3><p>Arthas是基于Java语言编写的，没有UI界面，所以是需要在命令栏或者Shell中进行启动的，可以在<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/releases">https://github.com/alibaba/arthas/releases</a> 中进行下载最新的Arthas版本。</p>
<p>当然也可以使用Linux 上的wget或者curl来直接获取到本地：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">wget</span> https://arthas.aliyun.com/arthas-boot.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">curl</span> -O https://arthas.aliyun.com/arthas-boot.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后使用常规的Java启动命令即可:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ java -jar arthas-boot.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里的<code>arthas-boot</code>是<code>Arthas</code>的启动程序，它启动后，会列出所有的Java进程，用户可以选择需要诊断的目标进程。</p>
<p>成功运行Arthas后，需要对其对应的Java程序进行设置监控。</p>
<p>Arthas它会输出一段文字，表示当前服务器中已经运行的Java程序列表：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ java -jar arthas-boot.jar
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> arthas-boot version: <span class="token number">3.5</span>.5
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Found existing java process, please choose one and input the serial number of the process, eg <span class="token builtin class-name">:</span> <span class="token number">1</span>. Then hit ENTER.
* <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: <span class="token number">42</span> zssaer.jar
* <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: <span class="token number">67</span> demo.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述服务器中共开启了两个Java程序，输入对应程序前的序号，比如需要监控demo应用，则输入<code>2</code>，然后回车。</p>
<p>在Attach成功之后，会打印Arthas LOGO。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/20220207152058.png"></p>
<p>Arthas默认监听的都是本地IP，即127.0.0.1，对于想实现远程监控应用的话，需要加上<code>--target-ip地址</code>的参数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ java -jar arthas-boot.jar --target-ip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="退出Arthas"><a href="#退出Arthas" class="headerlink" title="退出Arthas"></a>退出Arthas</h3><p>想要退出Arthas，输入exit或者quit即可。</p>
<p>当然这样只是在Shell中取消占用而已，后台依旧在运行中，想要完全退出并结束Arthas，输入stop即可。</p>
<h3 id="在浏览器操作"><a href="#在浏览器操作" class="headerlink" title="在浏览器操作"></a>在浏览器操作</h3><p>我们可以在Shell中直接进行操作，但是大多数情况下，考虑到方便，我们还是可以在Web下进行操作的。</p>
<p>Arthas支持Web连接。启动Arthas后，访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8563/%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9D%A5%E4%BD%BF%E7%94%A8Arthas%EF%BC%8C%E5%BD%93%E7%84%B6%E4%BE%9D%E7%84%B6%E6%98%AFShell%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%8F%90%E4%BE%9BUI%E6%93%8D%E4%BD%9C%E3%80%82:sweat">http://127.0.0.1:8563/，可以通过浏览器来使用Arthas，当然依然是Shell操作，并没有提供UI操作。:sweat</a>:</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/web-console.png"></p>
<h3 id="获取当前程序的实时面板"><a href="#获取当前程序的实时面板" class="headerlink" title="获取当前程序的实时面板"></a>获取当前程序的实时面板</h3><p>在成功启动Arthas并且监控到了对应的程序后，我们可以使用<code>dashboard</code>来进行查看当前系统的实时数据面板。</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/dashboard.png"></p>
<p>由于该命令是实时数据，所以会不断的刷新，影响正常观看，可以输入<code>Q</code>或者直接Ctrl+C来退出dashboard命令。</p>
<p>dashboard命令分为三部方：</p>
<ul>
<li>第一部方为Thread区，即展示当前JVM中的线程。</li>
<li>第二部分为Memory区，即展示该程序所花费的内存大小。</li>
<li>第三部分为运行环境区，即展示当前的JVM运行环境。</li>
</ul>
<h3 id="获取当前线程的进程操作"><a href="#获取当前线程的进程操作" class="headerlink" title="获取当前线程的进程操作"></a>获取当前线程的进程操作</h3><p>上面我们使用了<code>dashboard</code>来获取到了线程信息。我们可以通过使用<code>thread 线程ID</code>其线程的信息ID来获取到其线程的操作。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>arthas@42<span class="token punctuation">]</span>$ thread <span class="token number">1</span>
<span class="token string">"main"</span> <span class="token assign-left variable">Id</span><span class="token operator">=</span><span class="token number">1</span> TIMED_WAITING
    at java.base@15-ea/java.lang.Thread.sleep<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
    at java.base@15-ea/java.lang.Thread.sleep<span class="token punctuation">(</span>Thread.java:337<span class="token punctuation">)</span>
    at java.base@15-ea/java.util.concurrent.TimeUnit.sleep<span class="token punctuation">(</span>TimeUnit.java:446<span class="token punctuation">)</span>
    at app//demo.MathGame.main<span class="token punctuation">(</span>MathGame.java:17<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以获取到其，该线程最终是在其<code>MathGame.java</code>这个java文件中执行了其main方法。</p>
<p>我们可以使用<code>sc -d *Java名</code>来查询JVM中加载的类的信息。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>arthas@42<span class="token punctuation">]</span>$ sc -d *MathGame
 class-info        demo.MathGame                                                                    
 code-source       /root/math-game.jar                                                              
 name              demo.MathGame                                                                    
 isInterface       <span class="token boolean">false</span>                                                                            
 isAnnotation      <span class="token boolean">false</span>                                                                            
 isEnum            <span class="token boolean">false</span>                                                                            
 isAnonymousClass  <span class="token boolean">false</span>                                                                            
 isArray           <span class="token boolean">false</span>                                                                            
 isLocalClass      <span class="token boolean">false</span>                                                                            
 isMemberClass     <span class="token boolean">false</span>                                                                            
 isPrimitive       <span class="token boolean">false</span>                                                                            
 isSynthetic       <span class="token boolean">false</span>                                                                            
 simple-name       MathGame                                                                         
 modifier          public                                                                           
 annotation                                                                                         
 interfaces                                                                                         
 super-class       +-java.lang.Object                                                               
 class-loader      +-jdk.internal.loader.ClassLoaders<span class="token variable">$AppClassLoader</span>@c387f44                        
                     +-jdk.internal.loader.ClassLoaders<span class="token variable">$PlatformClassLoader</span>@3fbc1e80                
 classLoaderHash   c387f44                                                                          

Affect<span class="token punctuation">(</span>row-cnt:1<span class="token punctuation">)</span> cost <span class="token keyword">in</span> <span class="token number">38</span> ms.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="反编译类"><a href="#反编译类" class="headerlink" title="反编译类"></a>反编译类</h3><p>Arthas允许用户在其监控的程序中进行反编译操作。</p>
<p>使用指令<code>jad 类名</code>：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jad demo.MathGame<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它会同时输出其反编译的步骤:</p>
<p><img src="https://zssaer.oss-cn-chengdu.aliyuncs.com/20220208142400.png"></p>
<p>当然也可以只输出其反编译的代码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jad --source-only 类名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="在线执行代码"><a href="#在线执行代码" class="headerlink" title="在线执行代码"></a>在线执行代码</h3><p>Arthas中有个<code>ognl</code>命令，它可以用作在项目中动态执行代码。</p>
<p>比如调用静态的函数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ognl <span class="token string">'@java.lang.System@out.println("hello ognl")'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上述语句用来在项目中打印输出一个’hello ognl’ ，注意是在项目中，而不是在Arthas中。</p>
<p>还可以获取到类中的静态参数，前提需要获取到该类的ClassLoader的哈希值，使用<code>sc</code>功能：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ sc -d 类名 <span class="token operator">|</span> <span class="token function">grep</span> classLoaderHash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于类加载器是动态生成的，每次项目启动时哈希值都会变化，所以不能硬记下来。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ognl -c 类加载器哈希值 @类@参数名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="常见案例"><a href="#常见案例" class="headerlink" title="常见案例"></a>常见案例</h2><h3 id="捕捉错误"><a href="#捕捉错误" class="headerlink" title="捕捉错误"></a>捕捉错误</h3><p>Arthas使用<code>watch</code>命令可以进行动态捕捉其应用运行内容。</p>
<p><code>watch</code>命令接受四个参数：</p>
<ol>
<li>第一个参数是类名，支持通配 （必须）</li>
<li>第二个参数是动态捕捉函数名，支持通配 （必须）</li>
<li>第三个参数为捕捉的返回值内容，可以是一个返回对象（returnObj），也可以是一个多个内容，比如输入参数和抛出的错误（’{params, throwExp}’）,也可以是其某个属性(“params[0].size()”)。（必须）</li>
<li>第四个参数为条件表达式，用作过滤捕捉。</li>
</ol>
<p>比如：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">watch</span> com.example.demo.arthas.user.UserController * returnObj <span class="token string">'params[0] > 100'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>表示其捕捉UserController类中的任意方法下的 返回值 ，其条件是 其中第一个参数大于100。</p>
<p>当我们调用接口时，参数小于100的话，就不会打印内容，而大于100才则打印。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">watch</span> com.example.demo.arthas.user.UserController * returnObj <span class="token string">'params[0] > 100'</span>
Press Q or Ctrl+C to abort.
Affect<span class="token punctuation">(</span>class-cnt:1 , method-cnt:2<span class="token punctuation">)</span> cost <span class="token keyword">in</span> <span class="token number">47</span> ms.
<span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2019</span>-02-13 <span class="token number">19</span>:42:12<span class="token punctuation">;</span> <span class="token punctuation">[</span>cost<span class="token operator">=</span><span class="token number">0</span>.821443ms<span class="token punctuation">]</span> <span class="token assign-left variable">result</span><span class="token operator">=</span>@User<span class="token punctuation">[</span>
    <span class="token assign-left variable">id</span><span class="token operator">=</span>@Integer<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span>,
    <span class="token assign-left variable">name</span><span class="token operator">=</span>@String<span class="token punctuation">[</span>name101<span class="token punctuation">]</span>,
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>又比如，查看第一个参数的size：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">watch</span> com.taobao.container.Test <span class="token builtin class-name">test</span> <span class="token string">"params[0].size()"</span>
Press Ctrl+C to abort.
Affect<span class="token punctuation">(</span>class-cnt:1 , method-cnt:1<span class="token punctuation">)</span> cost <span class="token keyword">in</span> <span class="token number">22</span> ms.
@Integer<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="热代码更新"><a href="#热代码更新" class="headerlink" title="热代码更新"></a>热代码更新</h3><p>每次我们在进行代码问题修复的时候，总会在其 相关代码前后进行新增打印语句，用来打印出其相关的参数，以确保其正确性。</p>
<p>但是在已经上线的项目中，我们不能直接来进行编写源代码。</p>
<p>合理使用Arthas的<code>jad</code>/<code>mc</code>/<code>redefine</code>语句可以实现热代码更新。</p>
<p>首先，我们根据其日志输出，找到对应的类。使用<code>jad</code>来进行反编译类(Class-&gt;Java)。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jad --source-only com.example.demo.arthas.user.UserController <span class="token operator">></span> /tmp/UserController.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样UserController这个类就被反编译并保存在/tmp/UserController.java文件夹下了。</p>
<p>我们通过其Vim来进行编辑这个反编译后的类，在里面加入你所想要的内容。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> /tmp/UserController.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编辑并保存好了反编译的类后，我们就需要将其反编译后的类加入到项目中了。</p>
<p>了解类的动态加载的人或许知道，每个类通过其类加载器来进行动态加载的。我们要将编辑好的类动态加载进去的话，就需要找到其对应的类的类加载器。</p>
<p>我们使用Arthas中的<code>sc</code>命令来查询其类的类加载器哈希值，来准确定位。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ sc -d *UserController <span class="token operator">|</span> <span class="token function">grep</span> classLoaderHash
 classLoaderHash   1be6f5c3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里这个类的类加载器哈希值为1be6f5c3，我们先记住。</p>
<p>使用Arthas中的<code>mc</code>命令可以用来编译类(Java-&gt;Class)，并且通过<code>-c</code>或者<code>--classLoaderClass</code>参数指定其类的ClassLoader。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">mc</span> -c 1be6f5c3 /tmp/UserController.java -d /tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><em>注意：这里最后一个参数的 <code>/tmp</code>表示其Java应用内部的/tmp，并非前面的外部文件夹。</em></p>
<p>这样就成功将其编译并放置到了应用内部：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Memory compiler output:
/tmp/com/example/demo/arthas/user/UserController.class
Affect<span class="token punctuation">(</span>row-cnt:1<span class="token punctuation">)</span> cost <span class="token keyword">in</span> <span class="token number">346</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>最后我们还需要让应用重新加载编译好的类，使用Arthas的<code>redefine</code>命令：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ redefine /tmp/com/example/demo/arthas/user/UserController.class
redefine success, size: <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样我们就成功的实现了热代码更新，由此可见，Arthas不仅可以用来诊断Java应用，还可以用来在线修改其Java应用。</p>
<h3 id="过滤器拦截"><a href="#过滤器拦截" class="headerlink" title="过滤器拦截"></a>过滤器拦截</h3><p>在Java中我们比较头疼的就是过滤器的拦截了。比如说某个接口返回了一个401未授权的错误，那么如何去寻找这个抛出错误的过滤器？</p>
<p>我们可以使用<code>trace</code>命令来各种某个类。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ trace javax.servlet.Filter *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上述用来跟踪各个过滤器内容。</p>
<p>当我们再次访问接口出现调用过滤器的话，Arthas上就会开始打印内容：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token number">3.806273</span>ms<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>FilterChain</span><span class="token operator">:</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">|</span>   `<span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token number">3.447472</span>ms<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>arthas<span class="token punctuation">.</span></span>AdminFilterConfig</span>$<span class="token class-name">AdminFilter</span><span class="token operator">:</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">|</span>       `<span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token number">0.17259</span>ms<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpServletResponse</span><span class="token operator">:</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通常在最底层中我们会发现其真正的过滤器调用，比如这个则是AdminFilterConfig这个类中的AdminFilter调用了它的doFilter方法。</p>
</div>

      <!-- Post Comments -->
      
    <!-- 使用 changyan -->
<div id="changyan-comment">
    <!--PC和WAP自适应版-->
<div id="SOHUCS" sid="2022/02/08/arthas/"  ></div>
<script type="text/javascript">
(function(){
var appid = 'cyvzq2tmJ';
var conf = 'e61bcf9ca7baef66559e7e33e21fe290';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

</div>
<style>
    #changyan-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

    </div>
    <!-- Copyright 版权 start -->
    <div id="copyright">
  <ul>
    <li>
      &copy;Powered By
      <a target="_blank" rel="noopener" href="https://hexo.io/" style="border-bottom: none">hexo</a>
    </li>
    <li>Author: <a style="border-bottom: none">@Zssaer</a></li>
  </ul>
  <ul>
    <li>
      <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" id="beian">蜀ICP备2021031070号</a>
    </li>
  </ul>
  
  <span id="busuanzi_container_site_pv"> 2024 </span>
  
</div>

  </div>
  <script>
    const originalTitle = document.title;
    document.title = `Arthas - Java诊断工具` + `|` + originalTitle;
  </script>
</body>



 	
</html>
